| é¡¹ç›®                 | Apple Silicon (M1/M2/M3) | Intel Mac    |
| ------------------- | ------------------------  | ------------ |
| emacs-plus patch    | âœ… æ”¯æŒ                     | âœ… æ”¯æŒ         |
| no-titlebar / round | âœ…                        | âœ…            |
| native-comp         | âœ…                        | âœ…            |
| ç¼–è¯‘æµç¨‹             | **99% ç›¸åŒ**               | **99% ç›¸åŒ**   |
| Homebrew è·¯å¾„        | `/opt/homebrew`          | `/usr/local` |
| libgccjit           | ç¨éº»çƒ¦ä¸€ç‚¹                    | **æœ€ç¨³**       |

# æºç ç›®å½•
~/src/emacs-plus/
â”œâ”€â”€ emacs/                 # å®˜æ–¹ emacs æºç 
â”œâ”€â”€ homebrew-emacs-plus/   # åªç”¨æ¥å– patch & icon
â”œâ”€â”€ build/                 # ç¼–è¯‘ç›®å½•ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ build.sh               # ä¸€é”®è„šæœ¬


# å‡†å¤‡ç¯å¢ƒï¼ˆå¿…åšï¼‰
$ xcode-select --install
$ clang --version
$ brew install gnutls gnu-sed autoconf automake texinfo pkg-config libxml2 jansson gmp imagemagick tree-sitter libgccjit librsvg webp

$ brew info libgccjit

# éªŒè¯ï¼šlibgccjit
$ ls $(brew --prefix libgccjit)/lib/gcc/current

$ brew install tree-sitter tree-sitter@0.25 tree-sitter-cli
$ brew unlink tree-sitter 
$ brew link --overwrite tree-sitter@0.25


# éªŒè¯ï¼štree-sitter
$ pkg-config --modversion tree-sitter

> configure é˜¶æ®µå¿…é¡»çœ‹åˆ°ï¼š
> checking for libgccjit... yes

# 9ï¸âƒ£ Cocoa / NS æ”¯æŒï¼ˆmacOS GUI çš„æ ¹ï¼‰
--with-ns
--without-x

âš ï¸ å¦‚æœä½ è£…äº† XQuartzï¼Œå´æ²¡åŠ  --without-x
å¯èƒ½ä¼šå¾—åˆ° X11 Emacsï¼ˆä½ ç»å¯¹ä¸æƒ³è¦ï¼‰


# 1ï¸âƒ£ brew prefixï¼ˆå”¯ä¸€å¿…é¡»åŒºåˆ†ï¼‰
$ BREW_PREFIX=$(brew --prefix)
> Apple èŠ¯ç‰‡ï¼š/opt/homebrew
> Intelï¼š/usr/local

# Apple èŠ¯ç‰‡ï¼ˆæ›´å®¹æ˜“è¸©å‘ï¼‰
$ export LIBRARY_PATH="$BREW_PREFIX/opt/libgccjit/lib/gcc/current"
$ export CPATH="$BREW_PREFIX/opt/libgccjit/include"

# åœ¨ macOS é»˜è®¤åªæµ‹è¯• clang, å»ºè®®æ˜¾å¼æŒ‡å®šï¼ˆé¿å…è¢« brew gcc æ±¡æŸ“ï¼‰ï¼š
$ export CC=clang
$ export CXX=clang++

# Intelï¼ˆé€šå¸¸ä¸ç”¨ï¼‰

# ç¡®è®¤æ­£ç¡®çš„ SDK & macOS ç‰ˆæœ¬
# xcrun --show-sdk-path

# 3ï¸âƒ£ å®‰è£… prefixï¼ˆå»ºè®®åˆ†å¼€ï¼‰
> Apple èŠ¯ç‰‡ : /opt/emacs-plus-30-arm
> Intel      : /opt/emacs-plus-30-intel

# ä¸‹è½½ä»“åº“
$ git clone https://git.savannah.gnu.org/git/emacs.git
$ cd emacs
$ git checkout emacs-30

# ç”Ÿæˆ configureï¼ˆæºç ä»“åº“éœ€è¦ï¼‰
$ ./autogen.sh

# é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆé‡ç‚¹ï¼‰
$ ./configure \
  --with-ns \ 					# macOS åŸç”Ÿ GUIï¼ˆå¿…é¡»ï¼‰
  --with-native-compilation \ 	# å¯ç”¨ native-comp
  --with-json \ 				# LSP / modern packages
  --with-tree-sitter \ 			# Doom å¿…å¤‡
  --with-modules \ 				# Emacs modules
  --with-gnutls \ 
  --with-imagemagick \ 			# å›¾ç‰‡æ”¯æŒ
  --without-x \
  --prefix=/opt/emacs-30-$(uname -m) 		é¿å…æ±¡æŸ“ç³»ç»Ÿ

$ make -j$(sysctl -n hw.ncpu)
$ make install

$ sudo make install

$ /opt/emacs-30/bin/emacs --version

# ç”Ÿæˆ macOS Appï¼ˆå¼ºçƒˆæ¨èï¼‰
$ make install
$ make mac-app

# ç”Ÿæˆä½ç½®ï¼š
> nextstep/Emacs.app

# å¤åˆ¶åˆ° Applicationsï¼š
$ cp -R nextstep/Emacs.app /Applications/

# PATH & emacsclientï¼ˆå¾ˆé‡è¦ï¼‰
$ echo 'export PATH="/opt/emacs-30/bin:$PATH"' >> ~/.zshrc
$ source ~/.zshrc

# éªŒè¯ï¼š
$ which emacs
$ emacs --version

# éªŒè¯ native-comp æ˜¯å¦çœŸçš„å¯ç”¨, åœ¨ Emacs é‡Œæ‰§è¡Œï¼š
> M+x (native-comp-available-p)

è¿”å›ï¼š
t

ä»¥åŠï¼š
comp-version

# Doom Emacs ç‰¹åˆ«æ³¨æ„ï¼ˆä½ ç”¨å¾—å¾ˆå¤šï¼‰
$ rm -rf ~/.emacs.d/.local/cache/eln/
$ rm -rf ~/.cache/emacs/eln-cache/

$ Doom sync
$ ~/.emacs.d/bin/doom sync

# ç¡®è®¤ Doom ç”¨çš„æ˜¯æ–° Emacs
$ doom doctor

# å¸¸è§å‘ï¼ˆmacOS ä¸“å±ï¼‰
âŒ configure æ‰¾ä¸åˆ° libgccjit
$ brew install libgccjit
export LIBRARY_PATH="$(brew --prefix libgccjit)/lib/gcc/current:$LIBRARY_PATH"

âŒ ç¼–è¯‘æˆåŠŸä½†æ—  native-comp
ğŸ‘‰ 99% æ˜¯ configure æ—¶æ²¡æ£€æµ‹åˆ° gccjit
æ£€æŸ¥ï¼š
$ ./configure | grep -i jit

å¿…é¡»çœ‹åˆ°ï¼š
> checking for libgccjit... yes

âŒ Emacs.app å¯åŠ¨æ…¢ / eln æŠ¥é”™
defaults write org.gnu.Emacs NSAppSleepDisabled -bool YES





